/* eslint no-empty: 1 */

/*!
 * Module dependencies.
 */

var SchemaType = require('../schematype'),
    CastError = SchemaType.CastError,
    oid = require('../types/objectid'),
    utils = require('../utils'),
    Document;

/**
 * ObjectId SchemaType constructor.
 *
 * @param {String} key
 * @param {Object} options
 * @inherits SchemaType
 * @api public
 */

function ObjectId(key, options) {
  SchemaType.call(this, key, options, 'ObjectID');
}

/**
 * This schema type's name, to defend against minifiers that mangle
 * function names.
 *
 * @api public
 */
ObjectId.schemaName = 'ObjectId';

/*!
 * Inherits from SchemaType.
 */
<<<<<<< HEAD
ObjectId.prototype = Object.create(SchemaType.prototype);
=======
ObjectId.prototype = Object.create( SchemaType.prototype );
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
ObjectId.prototype.constructor = ObjectId;

/**
 * Adds an auto-generated ObjectId default if turnOn is true.
 * @param {Boolean} turnOn auto generated ObjectId defaults
 * @api public
 * @return {SchemaType} this
 */

ObjectId.prototype.auto = function(turnOn) {
  if (turnOn) {
    this.default(defaultId);
    this.set(resetId);
  }

  return this;
};

/**
<<<<<<< HEAD
 * Check if the given value satisfies a required validator.
 *
 * @param {Any} value
 * @param {Document} doc
 * @return {Boolean}
 * @api public
=======
 * Check required
 *
 * @api private
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
 */

ObjectId.prototype.checkRequired = function checkRequired(value, doc) {
  if (SchemaType._isRef(this, value, doc, true)) {
<<<<<<< HEAD
    return !!value;
  }
  return value instanceof oid;
=======
    return null != value;
  } else {
    return value instanceof oid;
  }
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
};

/**
 * Casts to ObjectId
 *
 * @param {Object} value
 * @param {Object} doc
 * @param {Boolean} init whether this is an initialization cast
 * @api private
 */

ObjectId.prototype.cast = function(value, doc, init) {
  if (SchemaType._isRef(this, value, doc, init)) {
    // wait! we may need to cast this to a document

<<<<<<< HEAD
    if (value === null || value === undefined) {
=======
    if (null == value) {
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
      return value;
    }

    // lazy load
    Document || (Document = require('./../document'));

    if (value instanceof Document) {
      value.$__.wasPopulated = true;
      return value;
    }

    // setting a populated path
    if (value instanceof oid) {
      return value;
    } else if (Buffer.isBuffer(value) || !utils.isObject(value)) {
      throw new CastError('ObjectId', value, this.path);
    }

    // Handle the case where user directly sets a populated
    // path to a plain object; cast to the Model used in
    // the population query.
    var path = doc.$__fullPath(this.path);
    var owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    var pop = owner.populated(path, true);
<<<<<<< HEAD
    var ret = value;
    if (!doc.$__.populated ||
        !doc.$__.populated[path] ||
        !doc.$__.populated[path].options ||
        !doc.$__.populated[path].options.options ||
        !doc.$__.populated[path].options.options.lean) {
      ret = new pop.options.model(value);
      ret.$__.wasPopulated = true;
    }

    return ret;
  }

  if (value === null || value === undefined) {
    return value;
  }

  if (value instanceof oid) {
    return value;
  }
=======
    var ret = new pop.options.model(value);
    ret.$__.wasPopulated = true;
    return ret;
  }

  // If null or undefined
  if (value == null) return value;

  if (value instanceof oid)
    return value;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

  if (value._id) {
    if (value._id instanceof oid) {
      return value._id;
    }
    if (value._id.toString instanceof Function) {
      try {
<<<<<<< HEAD
        return new oid(value._id.toString());
      } catch (e) {
      }
=======
        return oid.createFromHexString(value._id.toString());
      } catch (e) {}
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
    }
  }

  if (value.toString instanceof Function) {
    try {
<<<<<<< HEAD
      return new oid(value.toString());
=======
      return oid.createFromHexString(value.toString());
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
    } catch (err) {
      throw new CastError('ObjectId', value, this.path);
    }
  }

  throw new CastError('ObjectId', value, this.path);
};

/*!
 * ignore
 */

function handleSingle(val) {
  return this.cast(val);
}

ObjectId.prototype.$conditionalHandlers =
<<<<<<< HEAD
    utils.options(SchemaType.prototype.$conditionalHandlers, {
      $gt: handleSingle,
      $gte: handleSingle,
      $lt: handleSingle,
      $lte: handleSingle
    });
=======
  utils.options(SchemaType.prototype.$conditionalHandlers, {
    '$gt': handleSingle,
    '$gte': handleSingle,
    '$lt': handleSingle,
    '$lte': handleSingle
  });
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

/**
 * Casts contents for queries.
 *
 * @param {String} $conditional
 * @param {any} [val]
 * @api private
 */

ObjectId.prototype.castForQuery = function($conditional, val) {
  var handler;
  if (arguments.length === 2) {
    handler = this.$conditionalHandlers[$conditional];
<<<<<<< HEAD
    if (!handler) {
      throw new Error('Can\'t use ' + $conditional + ' with ObjectId.');
    }
    return handler.call(this, val);
  }
  return this.cast($conditional);
=======
    if (!handler)
      throw new Error("Can't use " + $conditional + " with ObjectId.");
    return handler.call(this, val);
  } else {
    return this.cast($conditional);
  }
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
};

/*!
 * ignore
 */

function defaultId() {
  return new oid();
}

function resetId(v) {
  this.$__._id = null;
  return v;
}

/*!
 * Module exports.
 */

module.exports = ObjectId;
