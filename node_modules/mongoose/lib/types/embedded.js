/* eslint no-func-assign: 1 */

/*!
 * Module dependencies.
 */

var Document = require('../document_provider')();
<<<<<<< HEAD
=======
var inspect = require('util').inspect;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
var PromiseProvider = require('../promise_provider');

/**
 * EmbeddedDocument constructor.
 *
 * @param {Object} obj js object returned from the db
 * @param {MongooseDocumentArray} parentArr the parent array of this document
 * @param {Boolean} skipId
 * @inherits Document
 * @api private
 */

function EmbeddedDocument(obj, parentArr, skipId, fields, index) {
  if (parentArr) {
    this.__parentArray = parentArr;
    this.__parent = parentArr._parent;
  } else {
    this.__parentArray = undefined;
    this.__parent = undefined;
  }
  this.__index = index;

  Document.call(this, obj, fields, skipId);

<<<<<<< HEAD
  var _this = this;
  this.on('isNew', function(val) {
    _this.isNew = val;
=======
  var self = this;
  this.on('isNew', function(val) {
    self.isNew = val;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
  });
}

/*!
 * Inherit from Document
 */
<<<<<<< HEAD
EmbeddedDocument.prototype = Object.create(Document.prototype);
=======
EmbeddedDocument.prototype = Object.create( Document.prototype );
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
EmbeddedDocument.prototype.constructor = EmbeddedDocument;

/**
 * Marks the embedded doc modified.
 *
 * ####Example:
 *
 *     var doc = blogpost.comments.id(hexstring);
 *     doc.mixed.type = 'changed';
 *     doc.markModified('mixed.type');
 *
 * @param {String} path the path which changed
 * @api public
 * @receiver EmbeddedDocument
 */

EmbeddedDocument.prototype.markModified = function(path) {
  this.$__.activePaths.modify(path);
<<<<<<< HEAD
  if (!this.__parentArray) {
    return;
  }
=======
  if (!this.__parentArray) return;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

  if (this.isNew) {
    // Mark the WHOLE parent array as modified
    // if this is a new document (i.e., we are initializing
    // a document),
    this.__parentArray._markModified();
  } else {
    this.__parentArray._markModified(this, path);
  }
};

/**
 * Used as a stub for [hooks.js](https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3)
 *
 * ####NOTE:
 *
 * _This is a no-op. Does not actually save the doc to the db._
 *
 * @param {Function} [fn]
 * @return {Promise} resolved Promise
 * @api private
 */

EmbeddedDocument.prototype.save = function(fn) {
  var Promise = PromiseProvider.get();
  return new Promise.ES6(function(resolve) {
    fn && fn();
    resolve();
  });
};

<<<<<<< HEAD
/*!
 * Registers remove event listeners for triggering
 * on subdocuments.
 *
 * @param {EmbeddedDocument} sub
 * @api private
 */

function registerRemoveListener(sub) {
  var owner = sub.ownerDocument();

  function emitRemove() {
    owner.removeListener('save', emitRemove);
    owner.removeListener('remove', emitRemove);
    sub.emit('remove', sub);
    owner = sub = null;
  }

  owner.on('save', emitRemove);
  owner.on('remove', emitRemove);
}

=======
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
/**
 * Removes the subdocument from its parent array.
 *
 * @param {Function} [fn]
 * @api public
 */

<<<<<<< HEAD
EmbeddedDocument.prototype.remove = function(options, fn) {
  if (!this.__parentArray || (options && options.noop)) {
    fn && fn(null);
    return this;
  }
=======
EmbeddedDocument.prototype.remove = function(fn) {
  if (!this.__parentArray) return this;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

  var _id;
  if (!this.willRemove) {
    _id = this._doc._id;
    if (!_id) {
      throw new Error('For your own good, Mongoose does not know ' +
<<<<<<< HEAD
          'how to remove an EmbeddedDocument that has no _id');
    }
    this.__parentArray.pull({_id: _id});
=======
                      'how to remove an EmbeddedDocument that has no _id');
    }
    this.__parentArray.pull({ _id: _id });
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
    this.willRemove = true;
    registerRemoveListener(this);
  }

<<<<<<< HEAD
  if (fn) {
    fn(null);
  }
=======
  if (fn)
    fn(null);
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

  return this;
};

<<<<<<< HEAD
=======
/*!
 * Registers remove event listeners for triggering
 * on subdocuments.
 *
 * @param {EmbeddedDocument} sub
 * @api private
 */

function registerRemoveListener(sub) {
  var owner = sub.ownerDocument();

  owner.on('save', emitRemove);
  owner.on('remove', emitRemove);

  function emitRemove() {
    owner.removeListener('save', emitRemove);
    owner.removeListener('remove', emitRemove);
    sub.emit('remove', sub);
    owner = sub = emitRemove = null;
  }
}

>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
/**
 * Override #update method of parent documents.
 * @api private
 */

EmbeddedDocument.prototype.update = function() {
  throw new Error('The #update method is not available on EmbeddedDocuments');
};

/**
 * Helper for console.log
 *
 * @api public
 */

EmbeddedDocument.prototype.inspect = function() {
<<<<<<< HEAD
  return this.toObject();
=======
  return inspect(this.toObject());
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
};

/**
 * Marks a path as invalid, causing validation to fail.
 *
 * @param {String} path the field to invalidate
 * @param {String|Error} err error which states the reason `path` was invalid
 * @return {Boolean}
 * @api public
 */

EmbeddedDocument.prototype.invalidate = function(path, err, val, first) {
  if (!this.__parent) {
    var msg = 'Unable to invalidate a subdocument that has not been added to an array.';
    throw new Error(msg);
  }

  var index = this.__index;
  if (typeof index !== 'undefined') {
    var parentPath = this.__parentArray._path;
    var fullPath = [parentPath, index, path].join('.');
    this.__parent.invalidate(fullPath, err, val);
  }

  if (first) {
    this.$__.validationError = this.ownerDocument().$__.validationError;
  }

  return true;
};

/**
 * Marks a path as valid, removing existing validation errors.
 *
 * @param {String} path the field to mark as valid
 * @api private
 * @method $markValid
 * @receiver EmbeddedDocument
 */

EmbeddedDocument.prototype.$markValid = function(path) {
  if (!this.__parent) {
    return;
  }

  var index = this.__index;
  if (typeof index !== 'undefined') {
    var parentPath = this.__parentArray._path;
    var fullPath = [parentPath, index, path].join('.');
    this.__parent.$markValid(fullPath);
  }
};

/**
 * Checks if a path is invalid
 *
 * @param {String} path the field to check
 * @api private
 * @method $isValid
 * @receiver EmbeddedDocument
 */

EmbeddedDocument.prototype.$isValid = function(path) {
  var index = this.__index;
  if (typeof index !== 'undefined') {
<<<<<<< HEAD
    return !this.__parent.$__.validationError ||
      !this.__parent.$__.validationError.errors[this.$__fullPath(path)];
=======

    return !this.__parent.$__.validationError ||
      !this.__parent.$__.validationError.errors[path];
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
  }

  return true;
};

/**
 * Returns the top level document of this sub-document.
 *
 * @return {Document}
 */

EmbeddedDocument.prototype.ownerDocument = function() {
  if (this.$__.ownerDocument) {
    return this.$__.ownerDocument;
  }

  var parent = this.__parent;
<<<<<<< HEAD
  if (!parent) {
    return this;
  }
=======
  if (!parent) return this;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

  while (parent.__parent) {
    parent = parent.__parent;
  }

<<<<<<< HEAD
  this.$__.ownerDocument = parent;
  return this.$__.ownerDocument;
=======
  return this.$__.ownerDocument = parent;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
};

/**
 * Returns the full path to this document. If optional `path` is passed, it is appended to the full path.
 *
 * @param {String} [path]
 * @return {String}
 * @api private
 * @method $__fullPath
 * @memberOf EmbeddedDocument
 */

EmbeddedDocument.prototype.$__fullPath = function(path) {
  if (!this.$__.fullPath) {
<<<<<<< HEAD
    var parent = this; // eslint-disable-line consistent-this
    if (!parent.__parent) {
      return path;
    }
=======
    var parent = this;
    if (!parent.__parent) return path;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d

    var paths = [];
    while (parent.__parent) {
      paths.unshift(parent.__parentArray._path);
      parent = parent.__parent;
    }

    this.$__.fullPath = paths.join('.');

    if (!this.$__.ownerDocument) {
      // optimization
      this.$__.ownerDocument = parent;
    }
  }

  return path
<<<<<<< HEAD
      ? this.$__.fullPath + '.' + path
      : this.$__.fullPath;
=======
    ? this.$__.fullPath + '.' + path
    : this.$__.fullPath;
>>>>>>> 28c6f978a4ba08bdae3bd531dac6bebf07cd4f5d
};

/**
 * Returns this sub-documents parent document.
 *
 * @api public
 */

EmbeddedDocument.prototype.parent = function() {
  return this.__parent;
};

/**
 * Returns this sub-documents parent array.
 *
 * @api public
 */

EmbeddedDocument.prototype.parentArray = function() {
  return this.__parentArray;
};

/*!
 * Module exports.
 */

module.exports = EmbeddedDocument;
